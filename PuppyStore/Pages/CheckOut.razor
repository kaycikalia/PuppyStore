@page "/checkout"
@inject CartService CartService
@inject NavigationManager Nav
@inject UserService UserService
@inject HttpClient Http

<h1>Checkout 🐾</h1>

@if (!UserService.IsLoggedIn)
{
    <div class="warning-box">
        <p>You must be logged in to check out.</p>
        <button class="btn-primary" @onclick="GoToLogin">Login</button>
    </div>
}
else if (!CartItems.Any())
{
    <p>Your cart is empty.</p>
    <button class="btn-primary" @onclick="GoToPuppies">Browse Puppies</button>
}
else
{
    <div class="checkout-page">

        <h2>Your Items</h2>

        <div class="cart-items">
            @foreach (var item in CartItems)
            {
                var puppy = CartService.GetPuppy(item.PuppyId);
                if (puppy != null)
                {
                    <div class="checkout-item">
                        <img src="@puppy.ImageUrl" class="checkout-img" />

                        <div class="checkout-info">
                            <h3>@puppy.Name</h3>
                            <p>@puppy.Breed • @puppy.Sex</p>
                            <p class="price">@puppy.Price.ToString("C0")</p>
                        </div>
                    </div>
                }
            }
        </div>

        <h2>Your Order</h2>

        <div class="summary-box">
            <p>Subtotal: @Subtotal.ToString("C")</p>
            <p>Tax (8%): @Tax.ToString("C")</p>
            <p class="summary-total">Total: @Total.ToString("C")</p>
        </div>

        <button class="btn-primary place-order" @onclick="PlaceOrder">
            Place Order
        </button>
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <p class="loading-message">@message</p>
}

@code {
    private string message = "";
    private List<CartItem> CartItems = new();

    protected override async Task OnInitializedAsync()
    {
        var user = await UserService.GetCurrentUser();

        if (user == null)
        {
            // guests cannot checkout, but load guest cart to avoid null issues
            CartItems = CartService.GuestCart;
            return;
        }

        // logged-in user → load DB cart
        await CartService.LoadCart();
        CartItems = CartService.Cart;
    }

    private decimal Subtotal =>
        CartItems.Sum(c => CartService.GetPuppy(c.PuppyId)?.Price ?? 0);

    private decimal Tax => Subtotal * 0.08m;

    private decimal Total => Subtotal + Tax;

    private void GoToLogin() => Nav.NavigateTo("/login");
    private void GoToPuppies() => Nav.NavigateTo("/availablepuppies");

    private async Task PlaceOrder()
    {
        message = "⏳ Loading your order summary...";
        StateHasChanged();

        var user = await UserService.GetCurrentUser();
        if (user != null)
        {
            // ⭐ Prepare receipt BEFORE clearing cart
            CartService.PrepareOrderForReceipt();

            // Build email body text
            string body = $"Hi {user.FirstName},\n\n" +
                          "Thank you for your order! Here’s your receipt:\n\n";

            decimal subtotal = 0;

            foreach (var item in CartService.LastOrder)
            {
                var puppy = CartService.GetPuppy(item.PuppyId);
                if (puppy != null)
                {
                    body += $"{puppy.Name} ({puppy.Breed}) — {puppy.Price:C}\n";
                    subtotal += puppy.Price;
                }
            }

            decimal tax = subtotal * 0.08m;
            decimal total = subtotal + tax;

            body += $"\nSubtotal: {subtotal:C}\nTax: {tax:C}\nTotal: {total:C}\n\n";
            body += "Thank you for choosing Puppy Love! 🐾";

            // Send to server API
            await Http.PostAsJsonAsync("api/order/send-confirmation", new
            {
                UserEmail = user.Email,
                Body = body
            });
        }

        await CartService.ClearCart();

        await Task.Delay(1200);
        Nav.NavigateTo("/ordersummary");
    }
}

<style>
    .checkout-page {
        max-width: 800px;
        margin: auto;
    }

    .checkout-item {
        display: flex;
        gap: 20px;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .checkout-img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
    }

    .checkout-info h3 {
        margin-bottom: 4px;
    }

    .summary-box {
        background: #fff0f6;
        border: 2px solid #ffb3d1;
        padding: 20px;
        border-radius: 10px;
    }

    .summary-total {
        font-size: 20px;
        font-weight: bold;
        color: #d12978;
    }

    .place-order {
        margin-top: 20px;
        padding: 14px 20px;
        font-size: 18px;
    }

    .warning-box {
        padding: 20px;
        border: 3px solid #d36ba0;
        border-radius: 10px;
        max-width: 400px;
        margin: auto;
        background: #fff0fa;
    }

    .loading-message {
        text-align: center;
        margin-top: 20px;
        color: #d12978;
        font-size: 18px;
        font-weight: bold;
    }
</style>