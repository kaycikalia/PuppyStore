@page "/login"
@inject NavigationManager Nav
@inject UserService UserService
@inject CartService CartService
@inject FavoritesService Favorites

<div class="login-container">

    <!-- LEFT SIDE IMAGE -->
    <div class="login-left">
        <img src="login.jpg" class="login-image" alt="Login Image" />
    </div>

    <!-- RIGHT LOGIN BOX -->
    <div class="login-box">

        @if (showWelcome)
        {
            <h2 class="welcome-heading">
                Welcome back, @UserService.CurrentUser!.FirstName! 🐾
            </h2>

            <p class="auth-message">@message</p>

            <button class="btn-login" @onclick="GoHome">Go Home</button>
            <button class="btn-login" @onclick="Logout">Log Out</button>
        }
        else if (UserService.IsLoggedIn)
        {
            <h2 class="welcome-heading">
                You are already logged in, @UserService.CurrentUser!.FirstName! 🐾
            </h2>

            <button class="btn-login" @onclick="GoHome">Go Home</button>
            <button class="btn-login" @onclick="Logout">Log Out</button>
        }
        else
        {
            <h2 class="login-heading">Member Login</h2>

            <div class="form-group">
                <label>Email</label>
                <input @bind="email" type="email" class="login-input" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <input @bind="password" type="password" class="login-input" />
            </div>

            <button type="button" class="btn-primary login-btn" @onclick="LoginUser">
                Login
            </button>

            <p class="auth-message">@message</p>

            <p class="create-link">
                <a href="/createuser" class="btn-link">Create your Account →</a>
            </p>
        }

    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string message = "";
    private bool showWelcome = false;

    protected override async Task OnInitializedAsync()
    {
        // Load user into memory
        var user = await UserService.GetCurrentUser();
    }

    private async Task LoginUser()
    {
        message = "Checking login...";
        StateHasChanged();

        var user = await UserService.LoginAsync(email, password);

        if (user == null)
        {
            message = "❌ Invalid email or password";
            return;
        }

        // ⭐ Merge Guest Cart → User Cart
        if (CartService.GuestCart.Any())
        {
            foreach (var item in CartService.GuestCart)
                await CartService.AddToCart(item.PuppyId);

            CartService.GuestCart.Clear();
        }

        // ⭐ Merge Guest Favorites → User Favorites
        if (Favorites.FavoriteIds.Any())
        {
            foreach (var favId in Favorites.FavoriteIds)
                await Favorites.AddFavorite(favId);

            Favorites.FavoriteIds.Clear();
        }
        // ⭐ Merge Guest Favorites → User Favorites
        await Favorites.MergeGuestFavoritesIntoUser();

        // Reload user favorites
        await Favorites.LoadFavorites();

        // Reload user data
        await CartService.LoadCart();
        await Favorites.LoadFavorites();

        showWelcome = true;
        message = $"🎉 Welcome back, {user.FirstName}!";
        StateHasChanged();

        await Task.Delay(1500);
    }


    private void GoHome() => Nav.NavigateTo("/");

    private async Task Logout()
    {
        await UserService.Logout();

        CartService.Cart.Clear();
        CartService.GuestCart.Clear();
        await Favorites.ClearFavorites();

        showWelcome = false;

        Nav.NavigateTo("/login", true);
    }
}
<style>
    .form-group {
        text-align: left;
        margin-bottom: 20px;
        align-items: center;
    }

        .form-group label {
            display: block;
            font-weight: 600;
            font-size: 18px;
            color: #a4577b;
            margin-bottom: 6px;
        }

    .login-input {
        width: 90%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 2px solid #ffd2e1;
        background: #fff8fb;
        font-size: 16px;
        align-content: center;
    }

        .login-input:focus {
            outline: none;
            border-color: #ff7ca8;
            background: white;
        }

    .login-btn {
        width: 150px;
        padding: 12px;
        margin-top: 10px;
        border-radius: 12px;
        font-size: 16px;
        background-color: #ff7ca8;
        color: white;
        border: none;
        cursor: pointer;
        transition: 0.2s ease-in-out;
    }

        .login-btn:hover {
            background-color: #ff5f98;
        }

    .create-link {
        margin-top: 20px;
    }

    .btn-link {
        color: #8a2387;
        font-weight: bold;
        text-decoration: underline;
    }

    .auth-message {
        color: #d36ba0;
        margin-top: 10px;
    }
</style>